// Prisma Schema for Nail Salon SaaS Platform
// Multi-tenant architecture with tenant_id on all business tables

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// TENANT & USER MANAGEMENT
// ============================================

model Tenant {
  id              String   @id @default(uuid())
  name            String
  subdomain       String   @unique
  email           String
  phone           String?
  address         String?
  logoUrl         String?
  
  // Subscription Info
  subscriptionPlan    SubscriptionPlan @default(TRIAL)
  subscriptionStatus  SubscriptionStatus @default(ACTIVE)
  subscriptionStartAt DateTime?
  subscriptionEndAt   DateTime?
  
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  users           User[]
  staff           Staff[]
  services        Service[]
  customers       Customer[]
  bookings        Booking[]
  platformPayments PlatformPayment[]

  @@map("tenants")
}

model User {
  id              String   @id @default(uuid())
  tenantId        String
  email           String
  passwordHash    String
  firstName       String
  lastName        String
  role            UserRole @default(STAFF)
  isActive        Boolean  @default(true)
  lastLoginAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("users")
}

// ============================================
// CORE BUSINESS ENTITIES
// ============================================

model Staff {
  id              String   @id @default(uuid())
  tenantId        String
  firstName       String
  lastName        String
  nickname        String?
  email           String?
  phone           String?
  avatarUrl       String?
  specialties     String[] // Array of service types they can do
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bookings        Booking[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("staff")
}

model Service {
  id              String   @id @default(uuid())
  tenantId        String
  name            String
  description     String?
  category        String   // e.g., "Manicure", "Pedicure", "Nail Art"
  durationMinutes Int      // Service duration
  price           Decimal  @db.Decimal(10, 2)
  imageUrl        String?
  isActive        Boolean  @default(true)
  displayOrder    Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bookingServices BookingService[]

  @@index([tenantId])
  @@map("services")
}

model Customer {
  id              String   @id @default(uuid())
  tenantId        String
  firstName       String
  lastName        String
  email           String?
  phone           String
  dateOfBirth     DateTime?
  notes           String?  // Special preferences, allergies, etc.
  totalVisits     Int      @default(0)
  totalSpent      Decimal  @default(0) @db.Decimal(10, 2)
  lastVisitAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bookings        Booking[]

  @@unique([tenantId, phone])
  @@index([tenantId])
  @@map("customers")
}

// ============================================
// BOOKING SYSTEM
// ============================================

model Booking {
  id              String        @id @default(uuid())
  tenantId        String
  customerId      String
  staffId         String
  bookingNumber   String        // Human-readable booking number
  
  // Time management
  startTime       DateTime
  endTime         DateTime
  totalDuration   Int           // Total duration in minutes
  
  // Pricing
  subtotal        Decimal       @db.Decimal(10, 2)
  discount        Decimal       @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal       @db.Decimal(10, 2)
  
  status          BookingStatus @default(PENDING)
  notes           String?
  cancelReason    String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer        Customer      @relation(fields: [customerId], references: [id])
  staff           Staff         @relation(fields: [staffId], references: [id])
  services        BookingService[]
  payment         BookingPayment?

  @@index([tenantId])
  @@index([tenantId, startTime])
  @@index([tenantId, staffId, startTime])
  @@map("bookings")
}

model BookingService {
  id              String   @id @default(uuid())
  bookingId       String
  serviceId       String
  serviceName     String   // Snapshot of service name at booking time
  price           Decimal  @db.Decimal(10, 2)
  duration        Int      // Duration in minutes

  // Relations
  booking         Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  service         Service  @relation(fields: [serviceId], references: [id])

  @@map("booking_services")
}

// ============================================
// PAYMENT SYSTEM
// ============================================

// Platform subscription payments (B2B)
model PlatformPayment {
  id              String        @id @default(uuid())
  tenantId        String
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("THB")
  
  // GB Prime Pay fields
  referenceNo     String        @unique
  transactionId   String?
  paymentMethod   PaymentMethod
  
  status          PaymentStatus @default(PENDING)
  paidAt          DateTime?
  
  // Subscription period this payment covers
  periodStart     DateTime
  periodEnd       DateTime
  
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("platform_payments")
}

// Booking payments (B2C - customer payments)
model BookingPayment {
  id              String        @id @default(uuid())
  bookingId       String        @unique
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("THB")
  
  // Stripe fields
  referenceNo     String        @unique
  paymentIntentId String?       // Stripe Payment Intent ID
  clientSecret    String?       // Stripe client secret for front-end
  transactionId   String?       // Legacy field
  paymentMethod   PaymentMethod
  qrCodeUrl       String?       // For QR code payments (legacy)
  
  status          PaymentStatus @default(PENDING)
  paidAt          DateTime?
  
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  booking         Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("booking_payments")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  OWNER       // Shop owner - full access
  MANAGER     // Manager - most access except billing
  STAFF       // Staff member - limited access
}

enum SubscriptionPlan {
  TRIAL
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentMethod {
  PROMPTPAY
  QR_CODE
  CREDIT_CARD
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}
